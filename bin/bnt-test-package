#!/usr/bin/env ruby

require_relative '../lib/bnt/env'

package_path       = ARGV[0]
package_name       = package_path.split("/").last
package_cage_path  = "#{Cage.packages_path}/#{package_name}"

release_path       = package_path.split("/")
release_path.pop
release_path.pop
release_path = release_path.join("/")

Runner.exec "sudo mkdir -p #{Cage.package_path(package_name)}"

unless File.directory? Cage.tmp_dir(package_name)
  Runner.exec "sudo mkdir #{Cage.tmp_dir(package_name)}"
end

Runner.exec "sudo mount --bind #{package_path} #{Cage.tmp_dir(package_name)}"

Runner.exec "sudo mkdir -p #{Cage.package_path(package_name)}/#{package_name}"
Runner.exec "sudo mount --bind #{release_path}/src/#{package_name} #{Cage.package_path(package_name)}/#{package_name}"

Runner.exec "sudo chroot #{Cage.path} sh /var/vcap/btt/make-package #{package_name} "
